<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Калькулятор цены реализации — кнопка + комиссия</title>
  <style>
    :root { --bg:#0f1220; --panel:#151932; --ink:#e6e8f2; --muted:#a7acc2; --accent:#6dd3fb; --ok:#2ecc71; --err:#ff6b6b; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--ink); }
    .wrap { max-width:980px; margin:32px auto; padding:0 16px; }
    h1 { font-size:26px; margin:0 0 6px; }
    .sub { color:var(--muted); margin-bottom:18px; }
    .panel { background:var(--panel); border:1px solid #232851; border-radius:14px; padding:20px; }
    label { display:block; font-size:14px; color:var(--muted); margin:0 0 6px; }
    .row { background:#101430; border:1px solid #242a55; border-radius:12px; padding:12px; margin-bottom:12px; }
    input, select { width:100%; background:transparent; border:none; outline:none; font-size:18px; color:var(--ink); }
    input[type="checkbox"] { transform: scale(1.2); }
    button { border:none; border-radius:12px; padding:12px 16px; font-size:16px; cursor:pointer; margin-right:8px; }
    .primary { background:var(--accent); color:#0a0f1a; font-weight:700; }
    .ghost { background:#0e1228; color:var(--ink); border:1px solid #273063; }
    .error { color:var(--err); margin-top:6px; min-height:1.2em; }
    .msg { color:var(--ok); margin-top:6px; min-height:1.2em; }
    .hint { font-size:12px; color:var(--muted); margin-top:4px; }
    .code { background:#0b0f20; border:1px dashed #2a3163; padding:4px 8px; border-radius:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Калькулятор цены реализации (с кнопкой)</h1>
    <div class="sub">
      Оставьте <strong>ровно одно</strong> поле из основных пустым — оно будет рассчитано.<br/>
      Комиссия маркетплейса указывается как <strong>% от цены без НДС</strong>.
    </div>
    <div class="panel">
      <div class="row"><label>Стоимость закупа</label><input id="purchase" type="number"></div>
      <div class="row"><label>Логистика</label><input id="logistics" type="number"></div>
      <div class="row"><label>Упаковка</label><input id="packaging" type="number"></div>
      <div class="row"><label>Растаможка</label><input id="customs" type="number"></div>
      <div class="row"><label>Маркетинг</label><input id="marketing" type="number"></div>
      <div class="row"><label>Хранение</label><input id="storage" type="number"></div>

      <div class="row">
        <label>Комиссия маркетплейса, % (от SP без НДС)</label>
        <input id="mpFeePct" type="number" step="0.01" min="0">
        <div class="hint">Комиссия считается как <span class="code">SP_net × %</span> и входит в себестоимость.</div>
      </div>

      <div class="row">
        <label>Тип маржи</label>
        <select id="marginMode">
          <option value="abs">$ — абсолютная</option>
          <option value="on_cost">% — наценка от себестоимости</option>
          <option value="on_sp">% — маржа от цены реализации (без НДС)</option>
        </select>
      </div>

      <div class="row"><label>Маржа</label><input id="margin" type="number"></div>

      <div class="row"><label>Ставка НДС, %</label><input id="vatRate" type="number"></div>
      <div class="row"><label><input type="checkbox" id="vatIncluded"> Цена реализации включает НДС</label></div>

      <div class="row"><label>Цена реализации</label><input id="selling" type="number"></div>

      <button class="primary" id="calcBtn">Рассчитать</button>
      <button class="ghost" id="resetBtn">Сброс</button>

      <div id="error" class="error"></div>
      <div id="msg" class="msg"></div>
    </div>
  </div>

<script>
const ids = ["purchase","logistics","packaging","customs","marketing","storage","margin","selling"];
const el = Object.fromEntries(ids.map(id => [id, document.getElementById(id)]));
const $marginMode = document.getElementById('marginMode');
const $vatRate = document.getElementById('vatRate');
const $vatIncluded = document.getElementById('vatIncluded');
const $mpFeePct = document.getElementById('mpFeePct');
const $err = document.getElementById('error'); const $msg=document.getElementById('msg');

function parseVal(v){if(v===""||v==null)return null;const n=Number(v);return Number.isFinite(n)?n:null;}
function round2(x){return Math.round((x+Number.EPSILON)*100)/100;}
function baseCosts(vals){return ["purchase","logistics","packaging","customs","marketing","storage"].map(k=>vals[k]??0).reduce((a,b)=>a+b,0);}
function getVatMultiplier(){const rate=parseVal($vatRate.value)||0;return 1+rate/100;}
function pct(x){return (parseVal(x)||0)/100;}

function compute(){
  const vals={}; ids.forEach(id=>vals[id]=parseVal(el[id].value));
  const empties=ids.filter(id=>vals[id]===null);
  const mode=$marginMode.value;
  const vatK=getVatMultiplier();
  const vatInc=$vatIncluded.checked;
  const c=pct($mpFeePct.value);
  const base0=baseCosts(vals);

  if(empties.length!==1){
    $err.textContent="Оставьте ровно одно поле пустым"; $msg.textContent=""; return;
  }
  $err.textContent=""; $msg.textContent="";
  const missing=empties[0];

  function SPnet_from_base_and_margin(){
    if(mode==="abs"){const M=vals.margin??0;return (base0+M)/(1-c);}
    if(mode==="on_cost"){const r=(vals.margin??0)/100;return (1+r)*base0/(1-c*(1+r));}
    const r=(vals.margin??0)/100;return base0/(1-c-r);
  }
  function SPnet_from_SP(){return vatInc?(vals.selling/vatK):vals.selling;}

  try{
    if(missing==="selling"){
      const SPnet=SPnet_from_base_and_margin();const SP=vatInc?SPnet*vatK:SPnet;el.selling.value=round2(SP);$msg.textContent="Рассчитана цена реализации";
    }else if(missing==="margin"){
      const SPnet=SPnet_from_SP();const costWithFee=base0+c*SPnet;let result;
      if(mode==="abs"){result=SPnet*(1-c)-base0;}
      else if(mode==="on_cost"){result=(SPnet/costWithFee-1)*100;}
      else {result=(1-c-base0/SPnet)*100;}
      el.margin.value=round2(result);$msg.textContent="Рассчитана маржа";
    }else{
      const SPnet=SPnet_from_SP();let result;const known=base0-(vals[missing]??0);
      if(mode==="abs"){const M=vals.margin??0;result=SPnet*(1-c)-M-known;}
      else if(mode==="on_cost"){const r=(vals.margin??0)/100;const base0_from=SPnet*(1-c*(1+r))/(1+r);result=base0_from-known;}
      else {const r=(vals.margin??0)/100;const base0_from=SPnet*(1-c-r);result=base0_from-known;}
      el[missing].value=round2(result);$msg.textContent="Рассчитано поле "+missing;
    }
  }catch(e){$err.textContent=e.message||"Ошибка";}
}

document.getElementById('calcBtn').addEventListener('click',compute);
document.getElementById('resetBtn').addEventListener('click',()=>{ids.forEach(id=>el[id].value="");$mpFeePct.value="";$vatRate.value="";$vatIncluded.checked=false;$msg.textContent="";$err.textContent="";});
</script>
</body>
</html>
