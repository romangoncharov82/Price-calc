<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Калькулятор цены реализации</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; padding:20px; }
    h2 { color:#4dd0e1; }
    label { display:block; margin-top:10px; }
    input, select { width:100%; padding:8px; margin-top:4px; background:#222; color:#fff; border:1px solid #555; border-radius:4px; }
    .error { color:red; font-size:0.9em; }
    button { margin-top:15px; padding:10px; background:#4dd0e1; border:none; border-radius:4px; cursor:pointer; }
    button:hover { background:#26c6da; }
    .result { background:#222; padding:10px; margin-top:15px; border-radius:6px; }
    canvas { margin-top:20px; background:#fff; border-radius:4px; }
  </style>
</head>
<body>
  <h2>Калькулятор цены реализации</h2>

  <label>Стоимость закупа <input type="number" id="purchase"></label>
  <label>Логистика <input type="number" id="logistics"></label>
  <label>Упаковка <input type="number" id="package"></label>
  <label>Растаможка <input type="number" id="customs"></label>
  <label>Маркетинг <input type="number" id="marketing"></label>
  <label>Хранение <input type="number" id="storage"></label>
  <label>Комиссия маркетплейса, % (от цены реализации без НДС) <input type="number" id="commission"></label>

  <label>Тип маржи
    <select id="marginType">
      <option value="abs">$ — абсолютная</option>
      <option value="cost">От себестоимости (%)</option>
      <option value="sp">От цены реализации (%)</option>
    </select>
  </label>

  <label>Маржа <input type="number" id="margin"></label>
  <label>Ставка НДС, % <input type="number" id="vat" value="0"></label>
  <label><input type="checkbox" id="includeVat"> Цена реализации включает НДС</label>
  <label>Цена реализации <input type="number" id="sp"></label>

  <button onclick="calculate()">Рассчитать</button>
  <button onclick="resetForm()">Сброс</button>

  <div class="result" id="output"></div>
  <canvas id="chart" width="400" height="200"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function calculate() {
  const purchase = parseFloat(document.getElementById("purchase").value)||0;
  const logistics = parseFloat(document.getElementById("logistics").value)||0;
  const packageCost = parseFloat(document.getElementById("package").value)||0;
  const customs = parseFloat(document.getElementById("customs").value)||0;
  const marketing = parseFloat(document.getElementById("marketing").value)||0;
  const storage = parseFloat(document.getElementById("storage").value)||0;
  const commissionPct = parseFloat(document.getElementById("commission").value)||0;
  const marginType = document.getElementById("marginType").value;
  const margin = parseFloat(document.getElementById("margin").value)||0;
  const vatRate = parseFloat(document.getElementById("vat").value)||0;
  const includeVat = document.getElementById("includeVat").checked;
  let sp = parseFloat(document.getElementById("sp").value);

  let cost = purchase + logistics + packageCost + customs + marketing + storage;

  let spNet;
  if (isNaN(sp)) {
    let profit=0;
    if(marginType==="abs"){ profit=margin; }
    else if(marginType==="cost"){ profit=cost*margin/100; }
    else if(marginType==="sp"){ profit=0; } // вычисляем отдельно ниже

    if(marginType==="sp"){
      spNet=(cost)/(1 - commissionPct/100 - margin/100);
    } else {
      spNet=(cost + profit)/(1 - commissionPct/100);
    }

    sp = includeVat ? spNet*(1+vatRate/100) : spNet;
  } else {
    spNet = includeVat ? sp/(1+vatRate/100) : sp;
  }

  let commission = spNet * commissionPct/100;
  let finalCost = cost + commission;
  let profit = spNet - finalCost;

  let output = `
    <b>Общая себестоимость:</b> ${cost.toFixed(2)}<br>
    <b>Комиссия маркетплейса:</b> ${commission.toFixed(2)}<br>
    <b>Итого себестоимость с комиссией:</b> ${finalCost.toFixed(2)}<br>
    <b>Цена реализации без НДС:</b> ${spNet.toFixed(2)}<br>
    <b>Цена реализации с НДС:</b> ${(spNet*(1+vatRate/100)).toFixed(2)}<br>
    <b>Прибыль:</b> ${profit.toFixed(2)}
  `;
  document.getElementById("output").innerHTML = output;

  // график
  const ctx=document.getElementById("chart");
  new Chart(ctx,{type:"bar",
    data:{labels:["Закуп","Логистика","Упаковка","Растаможка","Маркетинг","Хранение","Комиссия","Прибыль"],
      datasets:[{label:"Структура цены",data:[purchase,logistics,packageCost,customs,marketing,storage,commission,profit],
        backgroundColor:["#42a5f5","#26c6da","#66bb6a","#ffa726","#ab47bc","#8d6e63","#ef5350","#ffeb3b"]}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}

function resetForm(){
  document.querySelectorAll("input").forEach(el=>{ if(el.type!=="checkbox") el.value=""; });
  document.getElementById("includeVat").checked=false;
  document.getElementById("output").innerHTML="";
}
</script>
</body>
</html>